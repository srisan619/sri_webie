{%extends "users/base.html"%}


{%block content%}
<h4>Family Savings - {{year}}</h4>
<form method="get" class="mb-3 d-flex gap-2">
    <select name="year" class="form-select w-auto">
        {% for y in years %}
            <option value="{{ y }}"
                {% if y == year %}selected{% endif %}>
                {{ y }}
            </option>
        {% endfor %}
    </select>

    <button class="btn btn-primary btn-sm">
        Load
    </button>
</form>

<!-- Export XLS -->
{% if is_admin %}
<a href="{% url 'export_family_savings' %}?year={{year}}" class="btn btn-success btn-sm ms-2">
    Export Excel
</a>
<br/><br/>
{% endif %}
<table class="table table-bordered text-center">
    <thead class="table-light">
        <tr>
            <th>Family Name</th>
            {% for month_no, month_name in months %}
                <th>{{ month_name }}</th>
            {% endfor %}
            <th class="table-warning">Total</th>
        </tr>
    </thead>
    
    <tbody>
        {%for row in data%}
            <tr>
                <td class="text-start fw-bold">{{row.user.username}}</td>

                {% for month, amount in row.months.items %}
                <td>
                    {% if is_admin %}
                        <input type="number" class="form-control form-control-sm saving-input" value="{{amount}}" data-user="{{row.user.id}}" data-month="{{month}}" step="0.01">                        
                    {%else%}
                        <span class="text-muted">{{amount|default:"-"}}</span>
                    {%endif%}                    
                </td>
                {%endfor%}

                <td class="fw-bold row-total">{{row.total}}</td>
            </tr>
        {%endfor%}
    </tbody>
    <tfoot class="table-warning fw-bold">
        <tr>
            <td>Monthly Total</td>
            {% for month, total in monthly_totals.items %}
                <td>{{total}}</td>
            {% endfor %}
            <td>{{sum_monthly_totals}}</td>
        </tr>
    </tfoot>
</table>
{% if is_admin %}
    <script>
        document.querySelectorAll(".saving-input").forEach(input=>{
            input.addEventListener("change", function(){
                const userId = this.dataset.user;
                const month= this.dataset.month;
                const year= "{{year}}";
                const amount= this.value;

                fetch("{%url 'save_monthly_saving'%}", {
                    method: "POST",
                    headers: {
                        "X-CSRFToken": "{{csrf_token}}",
                        "content-type": "application/x-www-form-urlencoded"
                    },

                    body: new URLSearchParams({
                        user_id: userId,
                        month: month,
                        year: year,
                        amount: amount
                    })
                })
                .then(response=> response.json())
                .then(data=>{
                    if (data.success){
                        const row = this.closest('tr');
                        let total = 0;
                        row.querySelectorAll('.saving-input').forEach(i=>{
                            total += parseFloat(i.value || 0);
                        })
                        // row.querySelector('.row_total').innerText=total.toFixed(2);
                        row.querySelector('.row-total').textContent = total.toFixed(2);
                    }
                    else {
                        alert("Error saving data");
                    }
                })
                .catch(error=>{
                    console.error('Save error:', error);
                    alert("Failed to save: " + (error.error || error.message || error));
                });
            })
        })
    </script>
{%endif%}
{%endblock%}